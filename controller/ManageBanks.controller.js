/*
 * Copyright (C) 2009-2022 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["fin/cash/bankmaster/manage/util/BaseController","fin/cash/bankmaster/manage/util/Formatter","fin/cash/bankmaster/manage/util/Navigator","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/generic/app/navigation/service/NavigationHandler","sap/ui/comp/state/UIState"],function(B,F,N,S,a,U){"use strict";return B.extend("fin.cash.bankmaster.manage.controller.ManageBanks",{formatter:F,onInit:function(){this.getRouter().attachRoutePatternMatched(this.onRoutePatternMatched,this);this.getView().addStyleClass(this.getOwnerComponent().getContentDensityClass());this.externalNavigation=false;this.bankInternalId=null;this.version=this.getOwnerComponent()._version;if(this.version&&this.version==="basic"){this.byId("fin.cash.bankmaster.manage.bpNumberColumn").setVisible(false);this.byId("fin.cash.bankmaster.manage.accountCountColumn").setVisible(false);this.byId("fin.cash.bankmaster.manage.houseBankCountColumn").setVisible(false);this.byId("fin.cash.bankmaster.manage.hasHouseBanksFilter.FilterBar").setVisible(false);this.byId("fin.cash.bankmaster.manage.hasBankAccountsFilter.FilterBar").setVisible(false);this.byId("fin.cash.bankmaster.manage.isMarkedAsDeletedFilter.FilterBar").setVisible(false);this.byId("fin.cash.bankmaster.manage.myBankColumn").setVisible(false);var d=["HasBankAccounts","HasHouseBanks","BpNumber","BpGroup","Rating","RatingText","AccountCount","HouseBankCount"];this.byId("fin.cash.bankmaster.manage.bankSmartTable").setIgnoredFields(d);}var D=["AddressId","MyBank","GeneratedId","DeletionMark"];this.byId("fin.cash.bankmaster.manage.bankSmartTable").setIgnoredFields(D);var p=new sap.ui.model.json.JSONModel({headerExpanded:true});this.getView().setModel(p,"page");if(sap.ui.Device.system.desktop){this.getView().addStyleClass("sapUiSizeCompact");this.byId("fin.cash.bankmaster.manage.bankSmartTable").addStyleClass("sapUiSizeCondensed");}else{this.getView().addStyleClass("sapUiSizeCozy");this.byId("fin.cash.bankmaster.manage.bankSmartTable").addStyleClass("sapUiSizeCozy");}this.oCrossAppNavigator=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");this.oNavigationHandler=new a(this);this.bOnInitFinished=true;this.oSmartFilterBar=this.byId("fin.cash.bankmaster.manage.bankSmartFilterBar");this.oSmartTable=this.byId("fin.cash.bankmaster.manage.bankSmartTable");var t=this;if(this.oCrossAppNavigator){var n=this.oCrossAppNavigator.isNavigationSupported([{target:{semanticObject:"BankAccount",action:"maintainHierarchy"}}]).done(function(r){if(r[0].supported===false){t.byId("fin.cash.bankmaster.manage.managebankhierarchy").setVisible(false);}else{t.byId("fin.cash.bankmaster.manage.managebankhierarchy").setVisible(true);}});}},onManageBankHierarchyPressed:function(e){this.oCrossAppNavigator.toExternal({target:{semanticObject:"BankAccount",action:"maintainHierarchy"}});},onBeforeRendering:function(){var c="sapUiSizeCozy",C='sapUiSizeCompact',s='sapUiSizeCondensed';if(jQuery(document.body).hasClass(C)||this.getOwnerComponent().getContentDensityClass()===C){this.byId("fin.cash.bankmaster.manage.bankSmartTable").addStyleClass(s);}else if(jQuery(document.body).hasClass(c)||this.getOwnerComponent().getContentDensityClass()===c){this.byId("fin.cash.bankmaster.manage.bankSmartTable").addStyleClass(c);}},onSmartFilterInitialise:function(e){this.bOnInitSmartFilterBarFinished=true;this.byId("fin.cash.bankmaster.manage.bankSmartFilterBar").getControlByKey("MyBank").setSelectedKey(" ");this.initAppState();},initAppState:function(){if(!this.bOnInitFinished||!this.bOnInitSmartFilterBarFinished){return;}var p=this.oNavigationHandler.parseNavigation();var s=this.byId("fin.cash.bankmaster.manage.bankSmartFilterBar");var t=this;var b=null;p.done(function(A,u,n){if(n!==sap.ui.generic.app.navigation.service.NavType.initial){var h=A&&A.bNavSelVarHasDefaultsOnly;var o=new S(A.selectionVariant);var c=o.getParameterNames().concat(o.getSelectOptionsPropertyNames());var m={replace:true,strictMode:false};var d=A.selectionVariant;if(d&&(d.indexOf("\"Bank\"")!==-1||d.indexOf("\"BankInternalID\"")!==-1)){if(d.indexOf("\"Bank\"")!==-1){d=d.replace(/"Bank"/,"\"BankInternalId\"");}else{d=d.replace(/"BankInternalID"/,"\"BankInternalId\"");}}var e=new U({selectionVariant:JSON.parse(d),valueTexts:A.valueTexts});for(var i=0;i<c.length;i++){t.oSmartFilterBar.addFieldToAdvancedArea(c[i]);}if(!h||t.oSmartFilterBar.getCurrentVariantId()===""){t.oSmartFilterBar.clearVariantSelection();t.oSmartFilterBar.clear();t.oSmartFilterBar.setUiState(e,m);}if(A.tableVariantId){t.oSmartTable.setCurrentVariantId(A.tableVariantId);}t.restoreCustomAppStateData(A.customData);if(!h){t.oSmartFilterBar.search();}}});},storeCurrentAppState:function(){var A=this.oNavigationHandler.storeInnerAppState(this.getCurrentAppState());A.done(function(s){}.bind(this));A.fail(function(e){this._handleError(e);}.bind(this));return A;},getCurrentAppState:function(){var s=this.byId("fin.cash.bankmaster.manage.bankSmartFilterBar");var o=new S(JSON.stringify(s.getUiState().getSelectionVariant()));return{selectionVariant:o.toJSONString(),tableVariantId:this.oSmartTable.getCurrentVariantId(),customData:this.getCustomAppStateData(),valueTexts:s.getUiState().getValueTexts()};},getCustomAppStateData:function(){return{"myBank":this.byId("MyBankComboBox").getSelectedKey()};},_handleError:function(e){},restoreCustomAppStateData:function(c){if(c.myBank){this.byId("MyBankComboBox").setSelectedKey(c.myBank);}},onAfterApplyTableVariant:function(e){this.storeCurrentAppState();},setVisibleFilters:function(p){var A=this.byId("fin.cash.bankmaster.manage.bankSmartFilterBar").getAllFilterItems();var P=JSON.parse(p);var s=P.SelectOptions;for(var i=0;i<s.length;i++){for(var j=0;j<A.length;j++){var f=A[j].getName();if(s[i].PropertyName===f){A[j].setVisibleInFilterBar(true);}}}},onAssignedFiltersChanged:function(e){this.byId("FilterText").setText(this.byId("fin.cash.bankmaster.manage.bankSmartFilterBar").retrieveFiltersWithValuesAsText());},onToggleHeaderPressed:function(e){var p=this.getView().getModel("page");p.setProperty("/headerExpanded",(p.getProperty("/headerExpanded")===true)?false:true);},formatToggleButtonText:function(v){return v?this.getResourceBundle().getText("HIDE_FILTERS"):this.getResourceBundle().getText("SHOW_FILTERS");},onRoutePatternMatched:function(e){if(e.getParameter("name")!=="fullScreen"){return;}if(this.refresh.bankTable){this.byId("fin.cash.bankmaster.manage.bankSmartTable").rebindTable();this.refresh.bankTable=false;}},onBeforeVariantSave:function(e){this.byId("fin.cash.bankmaster.manage.bankSmartFilterBar").setFilterData({_CUSTOM:{CustomBankType:this.byId("fin.cash.bankmaster.manage.bankSmartFilterBar").getControlByKey("MyBank").getSelectedKey()}});},onAfterVariantLoad:function(e){var c=this.byId("fin.cash.bankmaster.manage.bankSmartFilterBar").getFilterData();var C=c._CUSTOM;if(C){this.byId("fin.cash.bankmaster.manage.bankSmartFilterBar").getControlByKey("MyBank").setSelectedKey(C.CustomBankType);}else{this.byId("fin.cash.bankmaster.manage.bankSmartFilterBar").getControlByKey("MyBank").setSelectedKey(" ");}},onBeforeRebindBankTable:function(e){var b=e.getParameter("bindingParams");if(!this.version||this.version!=="basic"){var c=e.getParameter("bindingParams");c.sorter.push(new sap.ui.model.Sorter("MyBank",true,false));if(this.bankInternalId!==null){var s=new sap.ui.model.Filter("BankInternalId","EQ",this.bankInternalId);b.filters.push(s);}var o=this.byId("fin.cash.bankmaster.manage.bankSmartFilterBar");var d=o.getControlByKey("MyBank").getSelectedKey();if(d!=" "){var f=new sap.ui.model.Filter("MyBank","EQ",d);b.filters.push(f);}if(b.parameters.select.indexOf("MyBank")===-1){b.parameters.select+=",MyBank";}}if(this.byId("bankTableSearchField").getValue()){var g=this.buildSearchQueryWithSearchField(this.byId("bankTableSearchField").getValue());b.filters.push(g);}b.parameters["countMode"]="Inline";},onBankDataReceived:function(e){var s=e.getSource();var b=s.getTable().getColumns();var C=sap.ui.getCore();var o=C.getConfiguration();var l=o.getLanguage();if(l=="HE"){for(var i=0;i<b.length;i++){var c=b[i].getCustomData()[0].getValue().columnKey;if(c=="UsedUnitCount"||c=="AccountCount"||c=="HouseBankCount"){b[i].setHAlign("Left");}}}},onCreateButtonPressed:function(){this.getRouter().navTo("BankScreen",{bankContextPath:"CreateEntitySet",mode:"create",bankInternalId:"undefined"},false);},onNavigateToDetailPressed:function(e){var b=e.getSource().getBindingContext().getPath().substr(1);var c=this.getView().getModel().oData[b].BankCountry;var d=this.getView().getModel().oData[b].BankInternalId;if(!c||!d)return;this.getRouter().navTo("BankScreen",{bankContextPath:"BankSet(BankCountry='"+c+"',BankInternalId='"+encodeURIComponent(d)+"')",mode:"read",bankInternalId:encodeURIComponent(d)},false);},onNavTargetsObtained:function(e){var p=e.getParameters();var A=p.actions;var m=[];for(var i=0;i<A.length;i++){if(A[i].getKey()==="BankAccount-manageMasterData"){var b=e.getSource().getBindingContext().getPath().substr(1);var c=this.getView().getModel().oData[b].BankCountry;var d=this.getView().getModel().oData[b].BankInternalId;if(c&&d){if(this.oCrossAppNavigator){var h=this.oCrossAppNavigator.hrefForExternal({target:{semanticObject:"BankAccount",action:"manageMasterData"},params:{BankCountry:[c],Bank:[d],BankAccountStatus:["02","09","10"]}});}}A[i].setHref(h);m.push(A[i]);}}p.show(null,m);},buildSearchQueryWithSearchField:function(s){var c=["BankInternalId","BankCountry","BankNumber","BankName","BankBranch","CountryName","BankCity","RegionName","BankStreet","Swift"];var f=[];var r=null;var b=this.byId("fin.cash.bankmaster.manage.bankSmartTable");if(s!=null&&s.length>0){var f=[];for(var i in c){f.push(new sap.ui.model.Filter(c[i],sap.ui.model.FilterOperator.Contains,s));}r=new sap.ui.model.Filter(f,false);}return r;},onSearchButtonPressed:function(e){this.byId("fin.cash.bankmaster.manage.bankSmartTable").rebindTable();this.storeCurrentAppState();}});});
