/*
 * Copyright (C) 2009-2022 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["fin/cash/bankmaster/manage/util/BaseController","fin/cash/bankmaster/manage/util/Creator","fin/cash/bankmaster/manage/util/Updater","fin/cash/bankmaster/manage/util/Navigator","fin/cash/bankmaster/manage/util/Messager","fin/cash/bankmaster/manage/util/Validator","fin/cash/bankmaster/manage/util/Formatter"],function(B,C,U,N,M,V,F){"use strict";return B.extend("fin.cash.bankmaster.manage.controller.HouseBank",{formatter:F,onInit:function(e){this.getRouter().attachRoutePatternMatched(this.onRoutePatternMatched,this);V._initMessagePopover(this);this.validatedFields=V._initValidatedFields();this.byId("messagesIndicator").setVisible(false);this.byId("HouseBankViewObjectPageLayout").setShowFooter(false);},onRoutePatternMatched:function(e){if(e.getParameter("name")!=="HouseBankScreen")return;this.getView().getModel().setDefaultBindingMode("TwoWay");var t=this.getText("HOURSE_BANK_OBJECT_HEADER_TITLE");this.getOwnerComponent().getService("ShellUIService").then(function(s){s.setTitle(t);},function(E){jQuery.sap.log.error("Cannot get ShellUIService",E,"fin.cash.bankmaster.manage.Component");});this.mode=e.getParameter("arguments").mode.toLowerCase();this.houseBankContextPath=e.getParameter("arguments").houseBankContextPath;this.bankContextPath=e.getParameter("arguments").bankContextPath;this.bankContext=new sap.ui.model.Context(this.getView().getModel(),"/"+this.bankContextPath);this.byId("fin.cash.bankmaster.manage.houseBankSmartForm.bankGroup").getModel().read("/"+this.bankContextPath);this.byId("fin.cash.bankmaster.manage.houseBankSmartForm.bankGroup").setBindingContext(this.bankContext);this.byId("fin.cash.bankmaster.manage.houseBankSmartForm.addressGroup").getModel().read("/"+this.bankContextPath);this.byId("fin.cash.bankmaster.manage.houseBankSmartForm.addressGroup").setBindingContext(this.bankContext);if(this.mode==="create"){this.byId("fin.cash.bankmaster.manage.editButton").setVisible(false);this.byId("fin.cash.bankmaster.manage.saveButton").setVisible(true);this.byId("fin.cash.bankmaster.manage.cancelButton").setVisible(true);this.byId("companyCodeField").setEnabled(true);this.byId("houseBankKeyField").setEnabled(true);this.byId("fin.cash.bankmaster.manage.houseBankSmartForm").setEditable(true);this.houseBankContext=this.getView().getModel().createEntry("/HouseBankSet");if(this.bankContext.getProperty()){for(var i in this.houseBankContext.getProperty()){if(i!=="__metadata"&&this.bankContext.getProperty()[i])this.houseBankContext.getProperty()[i]=this.bankContext.getProperty()[i];}}else{this.bankCountry=this.bankContextPath.match(/BankCountry='(\S*)',/)[1];this.bankInternalId=this.bankContextPath.match(/BankInternalId='(\S*)'/)[1];this.houseBankContext.getProperty()["BankCountry"]=this.bankCountry;var b=decodeURIComponent(this.bankInternalId);this.houseBankContext.getProperty()["BankInternalId"]=b;}this.byId("HouseBankViewObjectPageLayout").setShowFooter(true);}else{if(this.mode==="edit")this._toggleEditAndDisplay(true);else this._toggleEditAndDisplay(false);this.getView().getModel().read("/"+this.houseBankContextPath);this.houseBankContext=new sap.ui.model.Context(this.getView().getModel(),"/"+this.houseBankContextPath);}this.getView().setBindingContext(this.houseBankContext);},_toggleEditAndDisplay:function(s){if(s){this.mode="edit";}else{this.mode="read";}this.byId("HouseBankViewObjectPageLayout").setShowFooter(s);this.byId("fin.cash.bankmaster.manage.editButton").setVisible(!s);this.byId("fin.cash.bankmaster.manage.saveButton").setVisible(s);this.byId("fin.cash.bankmaster.manage.cancelButton").setVisible(s);this.byId("fin.cash.bankmaster.manage.houseBankSmartForm").setEditable(s);},onSaveButtonPressed:function(e){this.dataObject=this.getView().getBindingContext().getObject();for(var a in this.getView().getModel().createEntry("/HouseBankSet").getProperty()){if(a!=="__metadata"&&!this.dataObject[a]&&this.bankContext.getProperty()[a]&&a!=="BankNumber")this.dataObject[a]=this.bankContext.getProperty()[a];}this.saveSuccess=false;this.validatedMessages=[];if(this.mode==="create"){var n=true;n=V._setNonEmptyValidation(this,"companyCodeField",this.getText("NON_EMPTY_VALIDATION_COMPANY_CODE_TITLE"))&&n;n=V._setNonEmptyValidation(this,"houseBankKeyField",this.getText("NON_EMPTY_VALIDATION_HOUSE_BANK_KEY_TITLE"))&&n;if(n===false)return;var b=true;for(var i in this.getModel().oData){if(i.indexOf("HouseBankSet(CompanyCode='"+this.getView().getBindingContext().getProperty().CompanyCode+"',HouseBankKey='"+this.getView().getBindingContext().getProperty().HouseBankKey)!==-1){var o=this.getModel().oData[i];if(o.BankInternalId===this.bankContext.getObject().BankInternalId&&o.BankCountry===this.bankContext.getObject().BankCountry){b=false;V._setValidationMessage(this,"houseBankKeyField","Error",this.getText("HOUSE_BANK_EXIST_ERROR_TEXT"));}}}if(b===false)return;if(this.byId("houseBankKeyField").getValue().length>5)return;this.byId("fin.cash.bankmaster.manage.saveButton").setEnabled(false);this.byId("fin.cash.bankmaster.manage.saveButton").setText(this.getText("SAVING_BUTTON"));var t=this;$.when(C._createData(this,"/HouseBankSet",this.getText("CREATE_HOUSE_BANK_SUCCESS_TEXT"),this.getText("CREATE_HOUSE_BANK_ERROR_TEXT"))).then(function(r){if(r){t.byId("fin.cash.bankmaster.manage.saveButton").setEnabled(true);t.byId("fin.cash.bankmaster.manage.saveButton").setText(t.getText("SAVE_BUTTON"));if(t.saveSuccess===true){t.getRouter().navTo("HouseBankScreen",{mode:"read",bankContextPath:t.bankContextPath,houseBankContextPath:"HouseBankSet(CompanyCode='"+t.getView().getBindingContext().getProperty("CompanyCode")+"',HouseBankKey='"+t.getView().getBindingContext().getProperty("HouseBankKey")+"')"},true);}}});}else{U._updateData(this,this.getText("UPDATE_HOUSE_BANK_SUCCESS_TEXT"),this.getText("UPDATE_HOUSE_BANK_ERROR_TEXT"));this._toggleEditAndDisplay(false);}},onMessagePopoverPressed:function(){this.byId("messagesIndicator").setVisible(true);this.byId("messagesIndicator").setText(this.validatedMessages.length);this.messagePopover.openBy(this.byId("messagesIndicator"));},onCancelButtonPressed:function(){M._pressCancelButton(this);},onEditButtonPressed:function(e){this._toggleEditAndDisplay(true);},onNameOfContactPersonChanged:function(e){var v=e.getParameters().newValue;var m=this.getText("HOUSE_BANK_CONTACT_VALIDATION");if(v.charAt(0)==="+"||v.charAt(0)==="-"||v.charAt(0)==="="||v.charAt(0)==="\@"){this.byId("NameOfContactPerson").setValueState(sap.ui.core.ValueState.Error);this.byId("NameOfContactPerson").setValueStateText(m);}}});});
